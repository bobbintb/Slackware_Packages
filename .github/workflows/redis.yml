name: Build redis
on:
  workflow_dispatch:
env:
  VERSION: "7.4.0"
  NAME: "redis"
jobs:
  slackware-job:
    permissions: write-all
    runs-on: ubuntu-latest
    container: ghcr.io/bobbintb/autoslackpack
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Update and install packages
      run: |
        echo "================================= Updating packages ================================="
        CONF_FILE="/etc/slackpkg/slackpkg.conf"
        sed -i "s/^DIALOG=.*/DIALOG=off/" "$CONF_FILE"
        sed -i "s/^BATCH=.*/BATCH=on/" "$CONF_FILE"
        sed -i "s/^DEFAULT_ANSWER=.*/DEFAULT_ANSWER=y/" "$CONF_FILE"
        slackpkg update <<< y
        slackpkg install jemalloc
    - name: Clone and make
      run: |
        echo "================================= Cloning ${VERSION} from git ================================="
        URL="http://download.redis.io/releases/${NAME}-${VERSION}.tar.gz"
        cd ./$NAME
        wget $URL
        tar -xzvf ${NAME}-${VERSION}.tar.gz
        sh redis.SlackBuild
    - name: Commit changes
      uses: EndBug/add-and-commit@v9
      with:
        message: 'updated redis'
        add: '*.tar.gz'
